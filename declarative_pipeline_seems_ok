pipeline {
    
    agent {
        node {
            label 'ubuntu-build'
            }   // end of node
    }    // end of agent     
    
    stages {
            stage ('Checkout') {
                steps {
                    git 'https://github.com/yackey/AEF-CI.git'
                }   // end of steps
            }   // end of checkout stage      
            stage ('Debug Simulator Build') {
                steps {
                    dir ('build') {
                        sh 'rm -rf *'
                        sh 'conan install ../test -s os=Linux -s arch=x86_64 -s compiler=gcc -s compiler.version=6.4 -s build_type=Debug'
                        sh 'cmake -G "Unix Makefiles" -DCMAKE_EXPORT_COMPILE_COMMANDS=1 -DCMAKE_TOOLCHAIN_FILE=../Toolchain-GCC-x86_64.cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_TARGET_PROCESSOR=x86_64 ..'
                        sh 'cmake --build .'
                        //
                        sh './x86_64/bin/Debug/AefTest --gtest_output=xml:AefTestResultsRelease.xml'
                        sh 'ls'   
                        step([$class: 'JUnitResultArchiver', allowEmptyResults: true, testResults: 'AefTestResultsDebug.xml'])
                        //  
                        sh '/usr/bin/lcov --directory . --capture --output-file ./code_coverage.info -rc lcov_branch_coverage=1' 
                        sh '/usr/bin/genhtml code_coverage.info --branch-coverage --output-directory ./code_coverage_report_Debug'                        
                        //
                        publishHTML([allowMissing: false, 
                            alwaysLinkToLastBuild: false, 
                            keepAll: true, 
                            reportDir: 'code_coverage_report_Debug', 
                            reportFiles: 'index.html', 
                            reportName: 'Code Coverage Debug', 
                            reportTitles: ''])                         
                        //

                    } // end of dir 
                }   // end of steps
            }   // end of stage1
    }   // end of stages        
}

